--[[
    Custom UI Library V3 (Premium Clean)
    All features working + Icons for notifications
]]

local InputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")

local Library = {
    Open = true,
    AccentColor = Color3.fromRGB(140, 70, 240),
    Font = Enum.Font.GothamMedium,
    FontBold = Enum.Font.GothamBold,
    Theme = {
        Background = Color3.fromRGB(15, 15, 15),
        Sidebar = Color3.fromRGB(20, 20, 20),
        Section = Color3.fromRGB(22, 22, 22),
        Element = Color3.fromRGB(28, 28, 28),
        Text = Color3.fromRGB(240, 240, 240),
        TextDim = Color3.fromRGB(140, 140, 140),
        Outline = Color3.fromRGB(40, 40, 40),
        Shadow = Color3.fromRGB(0, 0, 0),
    },
    Icons = {
        check = "rbxassetid://7733955511",
        error = "rbxassetid://7733955740",
        eye = "rbxassetid://7743871002",
        shield = "rbxassetid://7743878857",
        info = "rbxassetid://7733964126"
    }
}

local NotificationHolder

local function ProtectGui(gui)
    if gethui then gui.Parent = gethui() 
    elseif syn and syn.protect_gui then syn.protect_gui(gui) gui.Parent = CoreGui 
    else gui.Parent = CoreGui end
end

local function Create(class, properties)
    local instance = Instance.new(class)
    for k, v in pairs(properties) do instance[k] = v end
    return instance
end

local function AddShadow(parent, transparency)
    local Shadow = Create("ImageLabel", {
        Name = "Shadow",
        Parent = parent,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, -15, 0, -15),
        Size = UDim2.new(1, 30, 1, 30),
        Image = "rbxassetid://6014261993",
        ImageColor3 = Library.Theme.Shadow,
        ImageTransparency = transparency or 0.5,
        SliceCenter = Rect.new(49, 49, 450, 450),
        ScaleType = Enum.ScaleType.Slice,
        ZIndex = parent.ZIndex - 1
    })
    return Shadow
end

local function MakeDraggable(trigger, object)
    local dragging, dragInput, dragStart, startPos
    trigger.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = object.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    trigger.InputChanged:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end 
    end)
    InputService.InputChanged:Connect(function(input) 
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            TweenService:Create(object, TweenInfo.new(0.05), {Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)}):Play()
        end 
    end)
end

-- Notification System with Icons
function Library:Notify(Title, Content, Duration, IconType)
    if not NotificationHolder then return end
    Duration = Duration or 3
    IconType = IconType or "info"
    
    local Notif = Create("Frame", {
        Parent = NotificationHolder,
        BackgroundColor3 = Library.Theme.Section,
        Size = UDim2.new(1, -10, 0, 0),
        BorderSizePixel = 0
    })
    Create("UICorner", {Parent = Notif, CornerRadius = UDim.new(0, 6)})
    Create("UIStroke", {Parent = Notif, Color = Library.Theme.Outline, Thickness = 1})
    
    -- Icon
    local Icon = Create("ImageLabel", {
        Parent = Notif,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 8),
        Size = UDim2.new(0, 34, 0, 34),
        Image = Library.Icons[IconType] or Library.Icons.info,
        ImageColor3 = Library.AccentColor
    })
    
    local TitleLbl = Create("TextLabel", {
        Parent = Notif, 
        Text = Title, 
        Position = UDim2.new(0, 48, 0, 5), 
        Size = UDim2.new(1, -58, 0, 18), 
        Font = Library.FontBold, 
        TextColor3 = Library.Theme.Text, 
        TextSize = 14, 
        TextXAlignment = Enum.TextXAlignment.Left, 
        BackgroundTransparency = 1
    })
    
    local ContentLbl = Create("TextLabel", {
        Parent = Notif, 
        Text = Content, 
        Position = UDim2.new(0, 48, 0, 23), 
        Size = UDim2.new(1, -58, 0, 15), 
        Font = Library.Font, 
        TextColor3 = Library.Theme.TextDim, 
        TextSize = 12, 
        TextXAlignment = Enum.TextXAlignment.Left, 
        BackgroundTransparency = 1
    })
    
    local Bar = Create("Frame", {
        Parent = Notif, 
        BackgroundColor3 = Library.AccentColor, 
        Position = UDim2.new(0, 0, 0, 0), 
        Size = UDim2.new(0, 3, 1, 0), 
        BorderSizePixel = 0
    })
    Create("UICorner", {Parent = Bar, CornerRadius = UDim.new(0, 6)})
    
    TweenService:Create(Notif, TweenInfo.new(0.3), {Size = UDim2.new(1, -10, 0, 50)}):Play()
    task.delay(Duration, function()
        TweenService:Create(Notif, TweenInfo.new(0.3), {Size = UDim2.new(1, -10, 0, 0)}):Play()
        task.wait(0.3)
        Notif:Destroy()
    end)
end

function Library:CreateWindow(Settings)
    local Title = Settings.Title or "UI"
    local Logo = Settings.Logo
    local Acrylic = Settings.Acrylic or false
    
    local ScreenGui = Create("ScreenGui", { Name = "EvictedUI", IgnoreGuiInset = true, ResetOnSpawn = false })
    ProtectGui(ScreenGui)
    
    -- Notification Holder
    NotificationHolder = Create("Frame", {
        Parent = ScreenGui,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -310, 1, -310),
        Size = UDim2.new(0, 300, 0, 300)
    })
    Create("UIListLayout", {Parent = NotificationHolder, Padding = UDim.new(0, 5), VerticalAlignment = Enum.VerticalAlignment.Bottom})

    -- Main Window
    local Main = Create("Frame", {
        Name = "Main",
        Parent = ScreenGui,
        BackgroundColor3 = Library.Theme.Background,
        BackgroundTransparency = Acrylic and 0.3 or 0,
        Position = UDim2.new(0.5, -375, 0.5, -275),
        Size = UDim2.new(0, 750, 0, 550),
        BorderSizePixel = 0,
        ClipsDescendants = false
    })
    Create("UICorner", {Parent = Main, CornerRadius = UDim.new(0, 8)})
    AddShadow(Main, 0.2)
    Create("UIStroke", {Parent = Main, Color = Library.Theme.Outline, Thickness = 1})

    -- Topbar
    local Topbar = Create("Frame", {
        Name = "Topbar",
        Parent = Main,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 45)
    })
    MakeDraggable(Topbar, Main)
    
    if Logo then
        local LogoImg = Create("ImageLabel", {
            Parent = Topbar,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 15, 0, 7),
            Size = UDim2.new(0, 30, 0, 30),
            Image = Logo,
            ScaleType = Enum.ScaleType.Fit
        })
    end

    local TopTitle = Create("TextLabel", {
        Parent = Topbar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, Logo and 55 or 20, 0, 0),
        Size = UDim2.new(1, -100, 1, 0),
        Font = Library.FontBold,
        Text = Title,
        TextColor3 = Library.Theme.Text,
        TextSize = 19,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local MinBtn = Create("TextButton", {
        Parent = Topbar,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -45, 0, 0),
        Size = UDim2.new(0, 45, 1, 0),
        Text = "−",
        Font = Library.FontBold,
        TextColor3 = Library.Theme.TextDim,
        TextSize = 26,
        AutoButtonColor = false
    })
    
    MinBtn.MouseEnter:Connect(function() TweenService:Create(MinBtn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play() end)
    MinBtn.MouseLeave:Connect(function() TweenService:Create(MinBtn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play() end)
    
    local Minimized = false
    MinBtn.MouseButton1Click:Connect(function()
        Minimized = not Minimized
        Main.ClipsDescendants = true
        if Minimized then
            TweenService:Create(Main, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {Size = UDim2.new(0, 750, 0, 45)}):Play()
            MinBtn.Text = "+"
        else
            TweenService:Create(Main, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {Size = UDim2.new(0, 750, 0, 550)}):Play()
            MinBtn.Text = "−"
            task.wait(0.3)
            Main.ClipsDescendants = false
        end
    end)

    -- Sidebar
    local Sidebar = Create("Frame", {
        Name = "Sidebar",
        Parent = Main,
        BackgroundColor3 = Library.Theme.Sidebar,
        BackgroundTransparency = Acrylic and 0.3 or 0,
        Position = UDim2.new(0, 0, 0, 45),
        Size = UDim2.new(0, 200, 1, -45),
        BorderSizePixel = 0
    })
    Create("UICorner", {Parent = Sidebar, CornerRadius = UDim.new(0, 8)})
    Create("Frame", {Parent = Sidebar, BackgroundColor3 = Library.Theme.Sidebar, BackgroundTransparency = Acrylic and 0.3 or 0, Size = UDim2.new(1,0,0,10), Position = UDim2.new(0,0,0,0), BorderSizePixel = 0})

    local TabContainer = Create("ScrollingFrame", {
        Parent = Sidebar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 10),
        Size = UDim2.new(1, -20, 1, -20),
        ScrollBarThickness = 0,
        BorderSizePixel = 0
    })
    Create("UIListLayout", {Parent = TabContainer, Padding = UDim.new(0, 6)})

    local Content = Create("Frame", {
        Name = "Content",
        Parent = Main,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 215, 0, 55),
        Size = UDim2.new(1, -225, 1, -65)
    })

    InputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.RightControl then 
            Library.Open = not Library.Open 
            Main.Visible = Library.Open 
        end
    end)

    local WindowObj = {}
    
    function WindowObj:AddTab(Name, IconId)
        local TabBtn = Create("TextButton", {
            Parent = TabContainer,
            BackgroundColor3 = Library.Theme.Background,
            Size = UDim2.new(1, 0, 0, 36),
            AutoButtonColor = false,
            Text = "",
            BackgroundTransparency = 1
        })
        Create("UICorner", {Parent = TabBtn, CornerRadius = UDim.new(0, 6)})
        
        local TitleLbl = Create("TextLabel", {
            Parent = TabBtn,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 35, 0, 0),
            Size = UDim2.new(1, -35, 1, 0),
            Text = Name,
            Font = Library.Font,
            TextColor3 = Library.Theme.TextDim,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left
        })

        local Icon = Create("ImageLabel", {
            Parent = TabBtn,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 8, 0.5, -10),
            Size = UDim2.new(0, 20, 0, 20),
            Image = IconId or "rbxassetid://7733960981",
            ImageColor3 = Library.Theme.TextDim
        })

        local TabPage = Create("Frame", {
            Parent = Content,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Visible = false
        })
        
        local SubTopBar = Create("Frame", {
            Parent = TabPage,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 35),
            Visible = false
        })
        Create("UIListLayout", {
            Parent = SubTopBar, 
            FillDirection = Enum.FillDirection.Horizontal, 
            Padding = UDim.new(0, 20),
            HorizontalAlignment = Enum.HorizontalAlignment.Left
        })
        
        local DefaultContainer = Create("ScrollingFrame", {
            Parent = TabPage,
            BackgroundTransparency = 1,
            Size = UDim2.new(1,0,1,0),
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = Library.Theme.Outline,
            CanvasSize = UDim2.new(0,0,0,0),
            BorderSizePixel = 0
        })
        local Left = Create("Frame", {Parent = DefaultContainer, BackgroundTransparency = 1, Size = UDim2.new(0.5, -8, 1, 0)})
        local Right = Create("Frame", {Parent = DefaultContainer, BackgroundTransparency = 1, Size = UDim2.new(0.5, -8, 1, 0), Position = UDim2.new(0.5, 8, 0, 0)})
        Create("UIListLayout", {Parent = Left, Padding = UDim.new(0, 12), SortOrder = Enum.SortOrder.LayoutOrder})
        Create("UIListLayout", {Parent = Right, Padding = UDim.new(0, 12), SortOrder = Enum.SortOrder.LayoutOrder})
        
        local function Activate()
            for _, v in pairs(TabContainer:GetChildren()) do
                if v:IsA("TextButton") then
                     TweenService:Create(v, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
                     TweenService:Create(v.TextLabel, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play()
                     TweenService:Create(v.ImageLabel, TweenInfo.new(0.2), {ImageColor3 = Library.Theme.TextDim}):Play()
                end
            end
            TweenService:Create(TabBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.95}):Play()
            TweenService:Create(TitleLbl, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()
            TweenService:Create(Icon, TweenInfo.new(0.2), {ImageColor3 = Library.AccentColor}):Play()
            
            for _, v in pairs(Content:GetChildren()) do v.Visible = false end
            TabPage.Visible = true
        end
        TabBtn.MouseButton1Click:Connect(Activate)
        
        if #TabContainer:GetChildren() == 2 then Activate() end

        local Tab = { HasSubTabs = false }
        
        function Tab:AddSubTab(SubName)
            if not Tab.HasSubTabs then
                Tab.HasSubTabs = true
                SubTopBar.Visible = true
                DefaultContainer.Visible = false
            end
            
            local SubBtn = Create("TextButton", {
                Parent = SubTopBar,
                BackgroundTransparency = 1,
                Text = SubName,
                Font = Library.FontBold,
                TextColor3 = Library.Theme.TextDim,
                TextSize = 15,
                AutomaticSize = Enum.AutomaticSize.X,
                Size = UDim2.new(0,0,1,0),
                AutoButtonColor = false
            })
            
            local Indicator = Create("Frame", {
                Parent = SubBtn,
                BackgroundColor3 = Library.AccentColor,
                Position = UDim2.new(0,0,1,-3),
                Size = UDim2.new(1,0,0,3),
                BackgroundTransparency = 1,
                BorderSizePixel = 0
            })
            Create("UICorner", {Parent = Indicator, CornerRadius = UDim.new(1, 0)})

            local SubContent = Create("ScrollingFrame", {
                Parent = TabPage,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 0, 0, 40),
                Size = UDim2.new(1, 0, 1, -40),
                ScrollBarThickness = 3,
                ScrollBarImageColor3 = Library.Theme.Outline,
                Visible = false,
                BorderSizePixel = 0
            })
            local SLeft = Create("Frame", {Parent = SubContent, BackgroundTransparency = 1, Size = UDim2.new(0.5, -8, 1, 0)})
            local SRight = Create("Frame", {Parent = SubContent, BackgroundTransparency = 1, Size = UDim2.new(0.5, -8, 1, 0), Position = UDim2.new(0.5, 8, 0, 0)})
            Create("UIListLayout", {Parent = SLeft, Padding = UDim.new(0, 12), SortOrder = Enum.SortOrder.LayoutOrder})
            Create("UIListLayout", {Parent = SRight, Padding = UDim.new(0, 12), SortOrder = Enum.SortOrder.LayoutOrder})
            
            SubBtn.MouseEnter:Connect(function() if Indicator.BackgroundTransparency == 1 then TweenService:Create(SubBtn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play() end end)
            SubBtn.MouseLeave:Connect(function() if Indicator.BackgroundTransparency == 1 then TweenService:Create(SubBtn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play() end end)
            
            SubBtn.MouseButton1Click:Connect(function()
                for _,v in pairs(SubTopBar:GetChildren()) do 
                     if v:IsA("TextButton") then
                        TweenService:Create(v, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play()
                        TweenService:Create(v.Frame, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
                     end
                end
                TweenService:Create(SubBtn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()
                TweenService:Create(Indicator, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
                
                for _,v in pairs(TabPage:GetChildren()) do if v:IsA("ScrollingFrame") then v.Visible = false end end
                SubContent.Visible = true
            end)
            
            local subcount = 0 
            for _,v in pairs(SubTopBar:GetChildren()) do if v:IsA("GuiObject") then subcount = subcount + 1 end end
            if subcount == 2 then
                 TweenService:Create(SubBtn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()
                 TweenService:Create(Indicator, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
                 SubContent.Visible = true
            end

            return {
                AddLeftGroupbox = function(self, Name) return self:CreateGroupbox(SLeft, Name) end,
                AddRightGroupbox = function(self, Name) return self:CreateGroupbox(SRight, Name) end,
                CreateGroupbox = Tab.CreateGroupbox
            }
        end
        
        function Tab:CreateGroupbox(Parent, Name)
            local Box = Create("Frame", {
                Parent = Parent,
                BackgroundColor3 = Library.Theme.Section,
                Size = UDim2.new(1, 0, 0, 50),
                AutomaticSize = Enum.AutomaticSize.Y,
                BorderSizePixel = 0
            })
            Create("UICorner", {Parent = Box, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = Box, Color = Library.Theme.Outline, Thickness = 1})
            
            local Header = Create("TextLabel", {
                Parent = Box,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 12, 0, 0),
                Size = UDim2.new(1, -24, 0, 32),
                Text = Name,
                Font = Library.FontBold,
                TextColor3 = Library.Theme.Text,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            Create("Frame", {Parent = Box, BackgroundColor3 = Library.Theme.Outline, Size = UDim2.new(1, 0, 0, 1), Position = UDim2.new(0,0,0,32), BorderSizePixel = 0})

            local Container = Create("Frame", {
                Parent = Box,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 12, 0, 40),
                Size = UDim2.new(1, -24, 0, 0),
                AutomaticSize = Enum.AutomaticSize.Y
            })
            Create("UIListLayout", {Parent = Container, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8)})
            Create("UIPadding", {Parent = Box, PaddingBottom = UDim.new(0, 12)})

            local Group = {}
            
            function Group:AddToggle(Text, Default, Callback)
                local Frame = Create("TextButton", {Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,22), Text = "", AutoButtonColor = false})
                local Label = Create("TextLabel", {Parent = Frame, BackgroundTransparency = 1, Text = Text, Font = Library.Font, TextColor3 = Library.Theme.TextDim, TextSize = 13, TextXAlignment=Enum.TextXAlignment.Left, Size = UDim2.new(1,-45,1,0)})
                
                local Check = Create("Frame", {Parent = Frame, BackgroundColor3 = Library.Theme.Element, Size = UDim2.new(0,20,0,20), Position = UDim2.new(1,-20,0,1), BorderSizePixel = 0})
                Create("UICorner", {Parent = Check, CornerRadius = UDim.new(0, 5)})
                Create("UIStroke", {Parent = Check, Color = Library.Theme.Outline, Thickness = 1})
                
                local Checkmark = Create("TextLabel", {Parent = Check, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Text = "✓", Font = Library.FontBold, TextColor3 = Library.Theme.Text, TextSize = 16, TextTransparency = 1})
                
                local State = Default or false
                local function Update()
                    if State then 
                        TweenService:Create(Check, TweenInfo.new(0.2), {BackgroundColor3 = Library.AccentColor}):Play() 
                        TweenService:Create(Checkmark, TweenInfo.new(0.2), {TextTransparency = 0}):Play()
                        TweenService:Create(Label, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()
                    else 
                        TweenService:Create(Check, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Element}):Play()
                        TweenService:Create(Checkmark, TweenInfo.new(0.2), {TextTransparency = 1}):Play()
                        TweenService:Create(Label, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play()
                    end
                    pcall(Callback, State)
                end
                Frame.MouseButton1Click:Connect(function() State = not State Update() end)
                Update()
                return {Set = function(self, v) State = v Update() end}
            end
            
            function Group:AddSlider(Text, Min, Max, Default, Callback)
                 local Frame = Create("Frame", {Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,42)})
                 local Label = Create("TextLabel", {Parent = Frame, BackgroundTransparency = 1, Text = Text, TextColor3 = Library.Theme.TextDim, Font = Library.Font, TextSize=13, Size = UDim2.new(1,0,0,16), TextXAlignment=Enum.TextXAlignment.Left})
                 local Value = Create("TextLabel", {Parent = Frame, BackgroundTransparency = 1, Text = tostring(Default), TextColor3 = Library.Theme.Text, Font=Library.Font, TextSize=13, Size = UDim2.new(1,0,0,16), TextXAlignment=Enum.TextXAlignment.Right})
                 
                 local Bg = Create("Frame", {Parent = Frame, BackgroundColor3 = Library.Theme.Element, Size = UDim2.new(1,0,0,7), Position = UDim2.new(0,0,0,24), BorderSizePixel = 0})
                 Create("UICorner", {Parent = Bg, CornerRadius = UDim.new(1,0)})
                 Create("UIStroke", {Parent = Bg, Color = Library.Theme.Outline, Thickness = 1})
                 
                 local Fill = Create("Frame", {Parent = Bg, BackgroundColor3 = Library.AccentColor, Size = UDim2.new(0,0,1,0), BorderSizePixel = 0})
                 Create("UICorner", {Parent = Fill, CornerRadius = UDim.new(1,0)})
                 
                 local function Set(v)
                     v = math.clamp(v, Min, Max)
                     TweenService:Create(Fill, TweenInfo.new(0.1), {Size = UDim2.new((v-Min)/(Max-Min), 0, 1, 0)}):Play()
                     Value.Text = math.floor(v*100)/100
                     pcall(Callback, v)
                 end
                 local Dragging = false
                 Bg.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = true Set(Min + ((Max-Min) * math.clamp((i.Position.X - Bg.AbsolutePosition.X)/Bg.AbsoluteSize.X, 0, 1))) end end)
                 InputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = false end end)
                 InputService.InputChanged:Connect(function(i) if Dragging and i.UserInputType == Enum.UserInputType.MouseMovement then Set(Min + ((Max-Min) * math.clamp((i.Position.X - Bg.AbsolutePosition.X)/Bg.AbsoluteSize.X, 0, 1))) end end)
                 Set(Default or Min)
                 return {Set = Set}
            end
            
            function Group:AddDropdown(Text, Options, Default, Callback)
                local DropFrame = Create("Frame", {Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,50), ClipsDescendants = false})
                local Label = Create("TextLabel", {Parent = DropFrame, Text = Text, Font = Library.Font, TextColor3 = Library.Theme.TextDim, Size = UDim2.new(1,0,0,18), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextSize = 13})
                
                local Btn = Create("TextButton", {Parent = DropFrame, BackgroundColor3 = Library.Theme.Element, Size = UDim2.new(1,0,0,26), Position = UDim2.new(0,0,0,22), Text = "", Font = Library.Font, TextColor3 = Library.Theme.Text, TextXAlignment = Enum.TextXAlignment.Left, AutoButtonColor = false, TextSize = 13, BorderSizePixel = 0})
                Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0,6)})
                Create("UIStroke", {Parent = Btn, Color = Library.Theme.Outline, Thickness = 1})
                
                local BtnText = Create("TextLabel", {Parent = Btn, Text = "  " .. tostring(Default), BackgroundTransparency = 1, Size = UDim2.new(1,-30,1,0), Font = Library.Font, TextColor3 = Library.Theme.Text, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left})
                
                local Arrow = Create("TextLabel", {Parent = Btn, Text = "▼", Font = Library.Font, TextColor3 = Library.Theme.TextDim, Size = UDim2.new(0,20,1,0), Position = UDim2.new(1,-24,0,0), BackgroundTransparency = 1, TextSize = 11})
                
                local ListFrame = Create("Frame", {Parent = DropFrame, BackgroundColor3 = Library.Theme.Element, Position = UDim2.new(0,0,0,50), Size = UDim2.new(1,0,0,0), BorderSizePixel = 0, ZIndex = 10, ClipsDescendants = true})
                Create("UICorner", {Parent = ListFrame, CornerRadius = UDim.new(0,6)})
                Create("UIStroke", {Parent = ListFrame, Color = Library.Theme.Outline, Thickness = 1})
                
                local List = Create("ScrollingFrame", {Parent = ListFrame, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), BorderSizePixel = 0, ScrollBarThickness = 2, ZIndex = 11})
                Create("UIListLayout", {Parent = List, SortOrder = Enum.SortOrder.LayoutOrder})
                
                local Open = false
                Btn.MouseButton1Click:Connect(function()
                    Open = not Open
                    if Open then
                        local height = math.min(#Options * 26, 130)
                        TweenService:Create(ListFrame, TweenInfo.new(0.2), {Size = UDim2.new(1,0,0,height)}):Play()
                        TweenService:Create(Arrow, TweenInfo.new(0.2), {Rotation = 180}):Play()
                    else
                        TweenService:Create(ListFrame, TweenInfo.new(0.2), {Size = UDim2.new(1,0,0,0)}):Play()
                        TweenService:Create(Arrow, TweenInfo.new(0.2), {Rotation = 0}):Play()
                    end
                end)
                
                for _, opt in pairs(Options) do
                    local OptBtn = Create("TextButton", {Parent = List, BackgroundColor3 = Library.Theme.Element, Size = UDim2.new(1,0,0,26), Text = "  " .. opt, Font = Library.Font, TextColor3 = Library.Theme.TextDim, TextXAlignment = Enum.TextXAlignment.Left, AutoButtonColor = false, BorderSizePixel = 0, ZIndex = 12})
                    OptBtn.MouseEnter:Connect(function() TweenService:Create(OptBtn, TweenInfo.new(0.1), {BackgroundColor3 = Library.Theme.Outline}):Play() end)
                    OptBtn.MouseLeave:Connect(function() TweenService:Create(OptBtn, TweenInfo.new(0.1), {BackgroundColor3 = Library.Theme.Element}):Play() end)
                    OptBtn.MouseButton1Click:Connect(function()
                        BtnText.Text = "  " .. opt
                        Open = false
                        TweenService:Create(ListFrame, TweenInfo.new(0.2), {Size = UDim2.new(1,0,0,0)}):Play()
                        TweenService:Create(Arrow, TweenInfo.new(0.2), {Rotation = 0}):Play()
                        pcall(Callback, opt)
                    end)
                end
            end
            
            function Group:AddColorPicker(Text, Default, Callback)
                local Frame = Create("Frame", {Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,26)})
                Create("TextLabel", {Parent = Frame, Text = Text, Font = Library.Font, TextColor3 = Library.Theme.TextDim, Size = UDim2.new(1,-40,1,0), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextSize = 13})
                
                local Btn = Create("TextButton", {Parent = Frame, BackgroundColor3 = Default or Color3.new(1,1,1), Size = UDim2.new(0,32,0,22), Position = UDim2.new(1,-32,0,2), Text = "", AutoButtonColor = false, BorderSizePixel = 0})
                Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0,5)})
                Create("UIStroke", {Parent = Btn, Color = Library.Theme.Outline, Thickness = 1})
                
                local CurrentColor = {H = 0, S = 1, V = 1}
                
                Btn.MouseButton1Click:Connect(function()
                    local Picker = Create("Frame", {Parent = ScreenGui, BackgroundColor3 = Library.Theme.Section, Position = UDim2.new(0.5,-125,0.5,-125), Size = UDim2.new(0,250,0,250), BorderSizePixel = 0, ZIndex = 100})
                    Create("UICorner", {Parent = Picker, CornerRadius = UDim.new(0,8)})
                    Create("UIStroke", {Parent = Picker, Color = Library.Theme.Outline, Thickness = 1})
                    AddShadow(Picker, 0.3)
                    
                    local Title = Create("TextLabel", {Parent = Picker, Text = "Color Picker", Position = UDim2.new(0,12,0,8), Size = UDim2.new(1,-24,0,20), Font = Library.FontBold, TextColor3 = Library.Theme.Text, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, BackgroundTransparency = 1})
                    
                    local SVPicker = Create("ImageButton", {Parent = Picker, BackgroundColor3 = Color3.fromHSV(CurrentColor.H, 1, 1), Position = UDim2.new(0,12,0,38), Size = UDim2.new(1,-24,0,150), Image = "rbxassetid://4155801252", BorderSizePixel = 0, AutoButtonColor = false})
                    Create("UICorner", {Parent = SVPicker, CornerRadius = UDim.new(0,6)})
                    
                    local HuePicker = Create("ImageButton", {Parent = Picker, BackgroundColor3 = Color3.new(1,1,1), Position = UDim2.new(0,12,0,196), Size = UDim2.new(1,-24,0,12), Image = "rbxassetid://3641079629", ImageColor3 = Color3.new(1,1,1), ScaleType = Enum.ScaleType.Crop, BorderSizePixel = 0, AutoButtonColor = false})
                    Create("UICorner", {Parent = HuePicker, CornerRadius = UDim.new(1,0)})
                    
                    local CloseBtn = Create("TextButton", {Parent = Picker, Text = "Close", Position = UDim2.new(0,12,1,-32), Size = UDim2.new(1,-24,0,24), BackgroundColor3 = Library.AccentColor, Font = Library.FontBold, TextColor3 = Library.Theme.Text, BorderSizePixel = 0, AutoButtonColor = false})
                    Create("UICorner", {Parent = CloseBtn, CornerRadius = UDim.new(0,6)})
                    CloseBtn.MouseButton1Click:Connect(function() Picker:Destroy() end)
                    
                    local function UpdateColor()
                        local col = Color3.fromHSV(CurrentColor.H, CurrentColor.S, CurrentColor.V)
                        Btn.BackgroundColor3 = col
                        SVPicker.BackgroundColor3 = Color3.fromHSV(CurrentColor.H, 1, 1)
                        pcall(Callback, col)
                    end
                    
                    local SVDragging = false
                    SVPicker.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            SVDragging = true
                            local pos = (input.Position - SVPicker.AbsolutePosition) / SVPicker.AbsoluteSize
                            CurrentColor.S = math.clamp(pos.X, 0, 1)
                            CurrentColor.V = math.clamp(1 - pos.Y, 0, 1)
                            UpdateColor()
                        end
                    end)
                    
                    InputService.InputChanged:Connect(function(input)
                        if SVDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                            local pos = (input.Position - SVPicker.AbsolutePosition) / SVPicker.AbsoluteSize
                            CurrentColor.S = math.clamp(pos.X, 0, 1)
                            CurrentColor.V = math.clamp(1 - pos.Y, 0, 1)
                            UpdateColor()
                        end
                    end)
                    
                    InputService.InputEnded:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            SVDragging = false
                        end
                    end)
                    
                    local HueDragging = false
                    HuePicker.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            HueDragging = true
                            local pos = (input.Position.X - HuePicker.AbsolutePosition.X) / HuePicker.AbsoluteSize.X
                            CurrentColor.H = math.clamp(pos, 0, 1)
                            UpdateColor()
                        end
                    end)
                    
                    InputService.InputChanged:Connect(function(input)
                        if HueDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                            local pos = (input.Position.X - HuePicker.AbsolutePosition.X) / HuePicker.AbsoluteSize.X
                            CurrentColor.H = math.clamp(pos, 0, 1)
                            UpdateColor()
                        end
                    end)
                    
                    InputService.InputEnded:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            HueDragging = false
                        end
                    end)
                end)
            end
            
            function Group:AddKeybind(Text, Default, Callback)
                local Frame = Create("Frame", {Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,26)})
                Create("TextLabel", {Parent = Frame, Text = Text, Font = Library.Font, TextColor3 = Library.Theme.TextDim, Size = UDim2.new(1,-75,1,0), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextSize = 13})
                
                local Btn = Create("TextButton", {Parent = Frame, BackgroundColor3 = Library.Theme.Element, Size = UDim2.new(0,70,0,22), Position = UDim2.new(1,-70,0,2), Text = (Default and Default.Name) or "None", Font = Library.Font, TextColor3 = Library.Theme.Text, TextSize = 11, AutoButtonColor = false, BorderSizePixel = 0})
                Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0,5)})
                Create("UIStroke", {Parent = Btn, Color = Library.Theme.Outline, Thickness = 1})
                
                local Listening = false
                Btn.MouseButton1Click:Connect(function()
                    if Listening then return end
                    Listening = true
                    Btn.Text = "..."
                    TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Library.AccentColor}):Play()
                    
                    local con
                    con = InputService.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.Keyboard then
                            local key = input.KeyCode
                            if key == Enum.KeyCode.Unknown then return end
                            Listening = false
                            Btn.Text = key.Name
                            TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Element}):Play()
                            pcall(Callback, key)
                            con:Disconnect()
                        end
                    end)
                end)
            end
            
            function Group:AddButton(Text, Callback)
                local Btn = Create("TextButton", {Parent = Container, BackgroundColor3 = Library.Theme.Element, Size = UDim2.new(1,0,0,30), Text = Text, Font = Library.FontBold, TextColor3 = Library.Theme.Text, TextSize = 13, AutoButtonColor = false, BorderSizePixel = 0})
                Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0,6)})
                Create("UIStroke", {Parent = Btn, Color = Library.Theme.Outline, Thickness = 1})
                
                Btn.MouseEnter:Connect(function() TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Library.AccentColor}):Play() end)
                Btn.MouseLeave:Connect(function() TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Element}):Play() end)
                Btn.MouseButton1Click:Connect(function() pcall(Callback) end)
            end
            
            function Group:AddInput(Text, Placeholder, Callback)
                local Frame = Create("Frame", {Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,50)})
                Create("TextLabel", {Parent = Frame, Text = Text, Font = Library.Font, TextColor3 = Library.Theme.TextDim, Size = UDim2.new(1,0,0,18), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextSize = 13})
                
                local Box = Create("TextBox", {Parent = Frame, BackgroundColor3 = Library.Theme.Element, Position = UDim2.new(0,0,0,22), Size = UDim2.new(1,0,0,26), PlaceholderText = Placeholder or "", Text = "", Font = Library.Font, TextColor3 = Library.Theme.Text, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left, BorderSizePixel = 0, ClearTextOnFocus = false})
                Create("UICorner", {Parent = Box, CornerRadius = UDim.new(0,6)})
                Create("UIStroke", {Parent = Box, Color = Library.Theme.Outline, Thickness = 1})
                Create("UIPadding", {Parent = Box, PaddingLeft = UDim.new(0,10)})
                
                Box.FocusLost:Connect(function(enter) if enter then pcall(Callback, Box.Text) end end)
            end
            
            function Group:AddLabel(Text)
                local Lbl = Create("TextLabel", {Parent = Container, Text = Text, Font = Library.Font, TextColor3 = Library.Theme.TextDim, Size = UDim2.new(1,0,0,18), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextSize = 13, TextWrapped = true})
                return {Set = function(self, txt) Lbl.Text = txt end}
            end
            
            return Group
        end
        
        function Tab:AddLeftGroupbox(Name) return self:CreateGroupbox(Left, Name) end
        function Tab:AddRightGroupbox(Name) return self:CreateGroupbox(Right, Name) end
        
        return Tab
    end
    
    return WindowObj
end

return Library
