--[[
    Custom UI Library
    Style: Evicted / Fluent / Linoria
    Features: Tabs, SubTabs, Groups, Elements, Notifications, Configs
]]

local InputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local Library = {
    Open = true,
    AccentColor = Color3.fromRGB(140, 70, 240),
    Font = Enum.Font.Gotham,
    FontBold = Enum.Font.GothamBold,
    Blacklist = {},
    Tabs = {},
    Container = nil,
    Theme = {
        Background = Color3.fromRGB(20, 20, 20),
        Sidebar = Color3.fromRGB(30, 30, 30),
        Group = Color3.fromRGB(25, 25, 25),
        Element = Color3.fromRGB(35, 35, 35),
        Text = Color3.fromRGB(240, 240, 240),
        TextDim = Color3.fromRGB(150, 150, 150),
        Outline = Color3.fromRGB(50, 50, 50),
    }
}

--// ProtectGui
local function ProtectGui(gui)
    if gethui and syn and syn.protect_gui then 
        syn.protect_gui(gui)
        gui.Parent = gethui()
    elseif gethui then 
        gui.Parent = gethui()
    elseif syn and syn.protect_gui then 
        syn.protect_gui(gui)
        gui.Parent = CoreGui
    else 
        gui.Parent = CoreGui
    end
end

--// Utility Functions
local function Create(class, properties)
    local instance = Instance.new(class)
    for k, v in pairs(properties) do
        instance[k] = v
    end
    return instance
end

local function MakeDraggable(topbarobject, object)
    local Dragging = nil
    local DragInput = nil
    local DragStart = nil
    local StartPosition = nil

    local function Update(input)
        local Delta = input.Position - DragStart
        local pos = UDim2.new(StartPosition.X.Scale, StartPosition.X.Offset + Delta.X, StartPosition.Y.Scale, StartPosition.Y.Offset + Delta.Y)
        object.Position = pos
    end

    topbarobject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            Dragging = true
            DragStart = input.Position
            StartPosition = object.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    Dragging = false
                end
            end)
        end
    end)

    topbarobject.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            DragInput = input
        end
    end)

    InputService.InputChanged:Connect(function(input)
        if input == DragInput and Dragging then
            Update(input)
        end
    end)
end

--// Notification System
local NotificationHolder = nil

function Library:Notify(Title, Content, Duration)
    if not NotificationHolder then return end
    Duration = Duration or 3

    local NotifFrame = Create("Frame", {
        Name = "Notification",
        Parent = NotificationHolder,
        BackgroundColor3 = Library.Theme.Group,
        BorderSizePixel = 0,
        Position = UDim2.new(1, 10, 1, -10), -- Start off screen
        Size = UDim2.new(1, -20, 0, 0), -- Animated Height
        ClipsDescendants = true,
    })
    
    local Stroke = Create("UIStroke", {
        Parent = NotifFrame,
        Color = Library.Theme.Outline,
        Thickness = 1
    })

    local Corner = Create("UICorner", {Parent = NotifFrame, CornerRadius = UDim.new(0, 6)})

    local NotifTitle = Create("TextLabel", {
        Parent = NotifFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 5),
        Size = UDim2.new(1, -20, 0, 20),
        Font = Library.FontBold,
        Text = Title,
        TextColor3 = Library.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local NotifContent = Create("TextLabel", {
        Parent = NotifFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 25),
        Size = UDim2.new(1, -20, 0, 15),
        Font = Library.Font,
        Text = Content,
        TextColor3 = Library.Theme.TextDim,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local AccentLine = Create("Frame", {
        Parent = NotifFrame,
        BackgroundColor3 = Library.AccentColor,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(0, 3, 1, 0)
    })
    local LineCorner = Create("UICorner", {Parent = AccentLine, CornerRadius = UDim.new(0, 6)})

    -- Animation
    TweenService:Create(NotifFrame, TweenInfo.new(0.3), {Size = UDim2.new(1, -20, 0, 50)}):Play()
    task.wait(Duration)
    TweenService:Create(NotifFrame, TweenInfo.new(0.3), {Size = UDim2.new(1, -20, 0, 0)}):Play()
    task.wait(0.3)
    NotifFrame:Destroy()
end


--// Window Creation
function Library:CreateWindow(Settings)
    local Title = Settings.Title or "UI Library"
    local AutoShow = Settings.AutoShow or true

    local ScreenGui = Create("ScreenGui", {
        Name = "Display",
        IgnoreGuiInset = true,
        ResetOnSpawn = false
    })
    ProtectGui(ScreenGui)

    -- Notification Holder (Bottom Right)
    NotificationHolder = Create("ScrollingFrame", {
        Name = "Notifications",
        Parent = ScreenGui,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -310, 1, -310),
        Size = UDim2.new(0, 300, 0, 300),
        ScrollBarThickness = 0,
        BorderSizePixel = 0, 
    })
    local NotifLayout = Create("UIListLayout", {
        Parent = NotificationHolder,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 5),
        VerticalAlignment = Enum.VerticalAlignment.Bottom
    })

    local MainFrame = Create("Frame", {
        Name = "Main",
        Parent = ScreenGui,
        BackgroundColor3 = Library.Theme.Background,
        Position = UDim2.new(0.5, -350, 0.5, -250),
        Size = UDim2.new(0, 700, 0, 500),
        BorderSizePixel = 0
    })
    Create("UICorner", {Parent = MainFrame, CornerRadius = UDim.new(0, 8)})
    Create("UIStroke", {Parent = MainFrame, Color = Library.Theme.Outline, Thickness = 1})

    MakeDraggable(MainFrame, MainFrame)

    -- Sidebar
    local Sidebar = Create("Frame", {
        Name = "Sidebar",
        Parent = MainFrame,
        BackgroundColor3 = Library.Theme.Sidebar,
        Size = UDim2.new(0, 200, 1, 0),
        BorderSizePixel = 0
    })
    Create("UICorner", {Parent = Sidebar, CornerRadius = UDim.new(0, 8)})
    
    -- Fix Corner Radius overlapping on right side of Sidebar
    local SidebarCover = Create("Frame", {
        Parent = Sidebar,
        BackgroundColor3 = Library.Theme.Sidebar,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -10, 0, 0),
        Size = UDim2.new(0, 10, 1, 0)
    })

    local AppTitle = Create("TextLabel", {
        Parent = Sidebar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 20, 0, 20),
        Size = UDim2.new(1, -40, 0, 30),
        Font = Library.FontBold,
        Text = Title,
        TextColor3 = Library.Theme.Text,
        TextSize = 20,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local TabContainer = Create("ScrollingFrame", {
        Name = "TabContainer",
        Parent = Sidebar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 60),
        Size = UDim2.new(1, -20, 1, -70),
        ScrollBarThickness = 0,
        BorderSizePixel = 0
    })
    Create("UIListLayout", {Parent = TabContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})

    local ContentArea = Create("Frame", {
        Name = "Content",
        Parent = MainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 210, 0, 20),
        Size = UDim2.new(1, -220, 1, -30),
    })

    -- Unload Key
    InputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.RightControl then
            Library.Open = not Library.Open
            MainFrame.Visible = Library.Open
        end
    end)

    local Window = {}
    
    function Window:AddTab(Name)
        local TabButton = Create("TextButton", {
            Name = Name,
            Parent = TabContainer,
            BackgroundColor3 = Library.Theme.Background, -- Inactive
            Size = UDim2.new(1, 0, 0, 35),
            AutoButtonColor = false,
            Font = Library.Font,
            Text = "   " .. Name,
            TextColor3 = Library.Theme.TextDim,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left
        })
        Create("UICorner", {Parent = TabButton, CornerRadius = UDim.new(0, 6)})

        local TabContent = Create("Frame", {
            Name = Name .. "Content",
            Parent = ContentArea,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Visible = false
        })

        -- SubTab / Topbar area
        local SubTopBar = Create("Frame", {
            Name = "SubTopBar",
            Parent = TabContent,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 30),
            Visible = false -- Only visible if SubTabs are added
        })
        local SubTabList = Create("UIListLayout", {
            Parent = SubTopBar,
            FillDirection = Enum.FillDirection.Horizontal,
            Padding = UDim.new(0, 10),
            HorizontalAlignment = Enum.HorizontalAlignment.Left
        })
        
        -- Default Content Area (If no subtabs are used)
        local DefaultPage = Create("ScrollingFrame", {
            Name = "Page",
            Parent = TabContent,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0), -- Full size
            ScrollBarThickness = 2,
            BorderSizePixel = 0
        })
        -- 2 Columns for Groups
        local LeftColumn = Create("Frame", {
            Name = "Left",
            Parent = DefaultPage,
            BackgroundTransparency = 1,
            Size = UDim2.new(0.5, -5, 1, 0),
            Position = UDim2.new(0, 0, 0, 0)
        })
        local RightColumn = Create("Frame", {
            Name = "Right",
            Parent = DefaultPage,
            BackgroundTransparency = 1,
            Size = UDim2.new(0.5, -5, 1, 0),
            Position = UDim2.new(0.5, 5, 0, 0)
        })
        Create("UIListLayout", {Parent = LeftColumn, Padding = UDim.new(0, 10), SortOrder = Enum.SortOrder.LayoutOrder})
        Create("UIListLayout", {Parent = RightColumn, Padding = UDim.new(0, 10), SortOrder = Enum.SortOrder.LayoutOrder})


        -- Logic to Switch Tabs
        TabButton.MouseButton1Click:Connect(function()
            for _, t in pairs(TabContainer:GetChildren()) do
                if t:IsA("TextButton") then
                    TweenService:Create(t, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Background, TextColor3 = Library.Theme.TextDim}):Play()
                end
            end
            TweenService:Create(TabButton, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Element, TextColor3 = Library.AccentColor}):Play()

            for _, f in pairs(ContentArea:GetChildren()) do
                f.Visible = false
            end
            TabContent.Visible = true
        end)
        
        -- Select first tab by default
        if #TabContainer:GetChildren() == 2 then -- 1 is Layout, 2 is this first button
            TweenService:Create(TabButton, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Element, TextColor3 = Library.AccentColor}):Play()
            TabContent.Visible = true
        end

        local TabObj = {
            Button = TabButton,
            Content = TabContent,
            DefaultPage = DefaultPage,
            HasSubTabs = false
        }

        function TabObj:AddSubTab(SubName)
            if not TabObj.HasSubTabs then
                TabObj.HasSubTabs = true
                SubTopBar.Visible = true
                DefaultPage.Visible = false -- Hide default page
            end

            local SubButton = Create("TextButton", {
                Name = SubName,
                Parent = SubTopBar,
                BackgroundTransparency = 1,
                Size = UDim2.new(0, 0, 1, 0), -- Auto scaled
                AutomaticSize = Enum.AutomaticSize.X,
                Font = Library.Font,
                Text = SubName .. "  |", -- Separator style as requested
                TextColor3 = Library.Theme.TextDim,
                TextSize = 14,
            })
            
            local SubPage = Create("ScrollingFrame", {
                Name = SubName .. "Page",
                Parent = TabContent,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, -35), -- moved down for topbar
                Position = UDim2.new(0, 0, 0, 35),
                ScrollBarThickness = 2,
                BorderSizePixel = 0,
                Visible = false
            })
            
             -- 2 Columns for Groups
            local SubLeft = Create("Frame", { Name = "Left", Parent = SubPage, BackgroundTransparency = 1, Size = UDim2.new(0.5, -5, 1, 0), Position = UDim2.new(0, 0, 0, 0) })
            local SubRight = Create("Frame", { Name = "Right", Parent = SubPage, BackgroundTransparency = 1, Size = UDim2.new(0.5, -5, 1, 0), Position = UDim2.new(0.5, 5, 0, 0) })
            Create("UIListLayout", {Parent = SubLeft, Padding = UDim.new(0, 10), SortOrder = Enum.SortOrder.LayoutOrder})
            Create("UIListLayout", {Parent = SubRight, Padding = UDim.new(0, 10), SortOrder = Enum.SortOrder.LayoutOrder})

            SubButton.MouseButton1Click:Connect(function()
                for _, btn in pairs(SubTopBar:GetChildren()) do 
                    if btn:IsA("TextButton") then 
                         TweenService:Create(btn, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play()
                    end 
                end
                TweenService:Create(SubButton, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()

                for _, p in pairs(TabContent:GetChildren()) do
                    if p.Name:match("Page") then p.Visible = false end
                end
                SubPage.Visible = true
            end)
            
            -- Auto select first subtab
            local subBtns = 0
            for _,v in pairs(SubTopBar:GetChildren()) do if v:IsA("TextButton") then subBtns = subBtns +1 end end
            if subBtns == 1 then
                TweenService:Create(SubButton, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()
                SubPage.Visible = true
            end

            return {
                AddLeftGroupbox = function(self, Name) return self:CreateGroupbox(SubLeft, Name) end,
                AddRightGroupbox = function(self, Name) return self:CreateGroupbox(SubRight, Name) end,
                CreateGroupbox = TabObj.CreateGroupbox -- Reuse function
            }
        end
        
        function TabObj:CreateGroupbox(ParentColumn, Name)
            local Groupbox = Create("Frame", {
                Name = Name,
                Parent = ParentColumn,
                BackgroundColor3 = Library.Theme.Group,
                Size = UDim2.new(1, 0, 0, 0), -- Auto sized
                AutomaticSize = Enum.AutomaticSize.Y,
                BorderSizePixel = 0
            })
            Create("UICorner", {Parent = Groupbox, CornerRadius = UDim.new(0, 4)})
            Create("UIStroke", {Parent = Groupbox, Color = Library.Theme.Outline, Thickness = 1})

            local Header = Create("TextLabel", {
                Parent = Groupbox,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 10, 0, 0),
                Size = UDim2.new(1, -20, 0, 30),
                Font = Library.FontBold,
                Text = Name,
                TextColor3 = Library.Theme.Text,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local Container = Create("Frame", {
                Parent = Groupbox,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 10, 0, 30),
                Size = UDim2.new(1, -20, 0, 0),
                AutomaticSize = Enum.AutomaticSize.Y
            })
            Create("UIListLayout", {Parent = Container, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
            
            -- Add padding at bottom
            Create("UIPadding", {Parent = Groupbox, PaddingBottom = UDim.new(0, 10)})

            local Group = {}
            
            function Group:AddToggle(Text, Default, Callback)
                local ToggleFrame = Create("TextButton", {
                    Name = "Toggle",
                    Parent = Container,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 25),
                    Text = "",
                    AutoButtonColor = false
                })
                
                local Label = Create("TextLabel", {
                    Parent = ToggleFrame,
                    BackgroundTransparency = 1,
                    Text = Text,
                    TextColor3 = Library.Theme.TextDim,
                    Font = Library.Font,
                    TextSize = 13,
                    Size = UDim2.new(1, -45, 1, 0),
                    TextXAlignment = Enum.TextXAlignment.Left
                })

                local Checkbox = Create("Frame", {
                    Parent = ToggleFrame,
                    BackgroundColor3 = Library.Theme.Element,
                    Size = UDim2.new(0, 40, 0, 20),
                    Position = UDim2.new(1, -40, 0, 2)
                })
                Create("UICorner", {Parent = Checkbox, CornerRadius = UDim.new(1, 0)})
                
                local Knob = Create("Frame", {
                    Parent = Checkbox,
                    BackgroundColor3 = Library.Theme.TextDim,
                    Size = UDim2.new(0, 16, 0, 16),
                    Position = UDim2.new(0, 2, 0.5, -8)
                })
                Create("UICorner", {Parent = Knob, CornerRadius = UDim.new(1, 0)})

                local Toggled = Default or false

                local function Update()
                    if Toggled then
                        TweenService:Create(Checkbox, TweenInfo.new(0.2), {BackgroundColor3 = Library.AccentColor}):Play()
                        TweenService:Create(Knob, TweenInfo.new(0.2), {Position = UDim2.new(1, -18, 0.5, -8), BackgroundColor3 = Library.Theme.Text}):Play()
                         TweenService:Create(Label, TweenInfo.new(0.2), {TextColor3 = Library.Theme.Text}):Play()
                    else
                        TweenService:Create(Checkbox, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Element}):Play()
                        TweenService:Create(Knob, TweenInfo.new(0.2), {Position = UDim2.new(0, 2, 0.5, -8), BackgroundColor3 = Library.Theme.TextDim}):Play()
                        TweenService:Create(Label, TweenInfo.new(0.2), {TextColor3 = Library.Theme.TextDim}):Play()
                    end
                    pcall(Callback, Toggled)
                end
                
                ToggleFrame.MouseButton1Click:Connect(function()
                    Toggled = not Toggled
                    Update()
                end)
            
                Update()
                return {
                    Set = function(self, bool) Toggled = bool Update() end
                }
            end

            function Group:AddSlider(Text, Min, Max, Default, Callback)
                 local SliderFrame = Create("Frame", {
                    Name = "Slider",
                    Parent = Container,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 45),
                })
                 
                local Label = Create("TextLabel", {
                    Parent = SliderFrame,
                    BackgroundTransparency = 1,
                    Text = Text,
                    TextColor3 = Library.Theme.TextDim,
                    Font = Library.Font,
                    TextSize = 13,
                    Size = UDim2.new(1, 0, 0, 20),
                    TextXAlignment = Enum.TextXAlignment.Left
                })
                
                local ValueLabel = Create("TextLabel", {
                    Parent = SliderFrame,
                    BackgroundTransparency = 1,
                    Text = tostring(Default),
                    TextColor3 = Library.Theme.Text,
                    Font = Library.Font,
                    TextSize = 13,
                    Size = UDim2.new(1, 0, 0, 20),
                    TextXAlignment = Enum.TextXAlignment.Right
                })

                local SlideBar = Create("Frame", {
                    Parent = SliderFrame,
                    BackgroundColor3 = Library.Theme.Element,
                    Size = UDim2.new(1, 0, 0, 6),
                    Position = UDim2.new(0, 0, 0, 25)
                })
                Create("UICorner", {Parent = SlideBar, CornerRadius = UDim.new(1, 0)})

                local Fill = Create("Frame", {
                    Parent = SlideBar,
                    BackgroundColor3 = Library.AccentColor,
                    Size = UDim2.new(0, 0, 1, 0)
                })
                Create("UICorner", {Parent = Fill, CornerRadius = UDim.new(1, 0)})

                local dragging = false
                
                local function Set(value)
                    value = math.clamp(value, Min, Max)
                    local percent = 1 - ((Max - value) / (Max - Min))
                    
                    TweenService:Create(Fill, TweenInfo.new(0.1), {Size = UDim2.new(percent, 0, 1, 0)}):Play()
                    ValueLabel.Text = string.format("%.1f", value) -- Format
                    pcall(Callback, value)
                end

                SlideBar.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                        local pos = math.clamp((input.Position.X - SlideBar.AbsolutePosition.X) / SlideBar.AbsoluteSize.X, 0, 1)
                        Set(Min + ((Max - Min) * pos))
                    end
                end)
                
                InputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                    end
                end)
                
                InputService.InputChanged:Connect(function(input)
                    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                         local pos = math.clamp((input.Position.X - SlideBar.AbsolutePosition.X) / SlideBar.AbsoluteSize.X, 0, 1)
                         Set(Min + ((Max - Min) * pos))
                    end
                end)

                Set(Default)
            end
            
            function Group:AddDropdown(Text, Options, Default, Callback)
                -- Simplistic Dropdown
                local DropFrame = Create("Frame", {
                     Name = "Dropdown",
                     Parent = Container,
                     BackgroundTransparency = 1,
                     Size = UDim2.new(1, 0, 0, 50),
                     ClipsDescendants = true
                })
                
                local Label = Create("TextLabel", {
                    Parent = DropFrame,
                    BackgroundTransparency = 1,
                    Text = Text,
                    TextColor3 = Library.Theme.TextDim,
                    Font = Library.Font,
                    TextSize = 13,
                    Size = UDim2.new(1, 0, 0, 20),
                    TextXAlignment = Enum.TextXAlignment.Left
                })
                
                local Button = Create("TextButton", {
                    Parent = DropFrame,
                    BackgroundColor3 = Library.Theme.Element,
                    Size = UDim2.new(1, 0, 0, 25),
                    Position = UDim2.new(0, 0, 0, 22),
                    Text = "  " .. tostring(Default),
                    Font = Library.Font,
                    TextColor3 = Library.Theme.Text,
                    TextSize = 13,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    AutoButtonColor = false
                })
                Create("UICorner", {Parent = Button, CornerRadius = UDim.new(0, 4)})
                
                local Open = false
                local OptionHeight = 25
                local MAX_SHOW = 4
                
                local List = Create("ScrollingFrame", {
                    Parent = DropFrame,
                    BackgroundColor3 = Library.Theme.Element,
                    Position = UDim2.new(0, 0, 1, 0), -- initially below
                    Size = UDim2.new(1, 0, 0, 100), -- Dynamic
                    ScrollBarThickness = 2,
                    Visible = false,
                    ZIndex = 10 
                })
                Create("UIListLayout", {Parent = List, SortOrder = Enum.SortOrder.LayoutOrder})
                
                local function RefreshList()
                     for _,v in pairs(List:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
                     
                     for _, Option in pairs(Options) do
                        local OptBtn = Create("TextButton", {
                             Parent = List,
                             BackgroundColor3 = Library.Theme.Element,
                             Size = UDim2.new(1, 0, 0, 25),
                             Text = Option,
                             Font = Library.Font,
                             TextColor3 = Library.Theme.TextDim,
                             TextSize = 13,
                             ZIndex = 11
                        })
                        
                        OptBtn.MouseButton1Click:Connect(function()
                             Button.Text = "  " .. Option
                             pcall(Callback, Option)
                             Open = false
                             TweenService:Create(DropFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 50)}):Play()
                        end)
                     end
                end
                
                Button.MouseButton1Click:Connect(function()
                    Open = not Open
                    RefreshList()
                    if Open then
                        local Count = #Options
                        local Show = math.clamp(Count, 0, MAX_SHOW)
                        TweenService:Create(DropFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 50 + (Show * OptionHeight))}):Play()
                        List.Visible = true
                    else
                         TweenService:Create(DropFrame, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 50)}):Play()
                         task.wait(0.2)
                         List.Visible = false
                    end
                end)
            end
            
            function Group:AddColorPicker(Text, Default, Callback)
                local ColorFrame = Create("Frame", {
                    Name = "ColorPicker",
                    Parent = Container,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 40)
                })
                
                local Label = Create("TextLabel", {
                    Parent = ColorFrame,
                    BackgroundTransparency = 1,
                    Text = Text,
                    TextColor3 = Library.Theme.TextDim,
                    Font = Library.Font,
                    TextSize = 13,
                    Size = UDim2.new(1, -50, 1, 0),
                    TextXAlignment = Enum.TextXAlignment.Left
                })
                
                local PickerBtn = Create("TextButton", {
                    Parent = ColorFrame,
                    BackgroundColor3 = Default or Color3.new(1,1,1),
                    Size = UDim2.new(0, 40, 0, 20),
                    Position = UDim2.new(1, -40, 0, 10),
                    Text = "",
                    AutoButtonColor = false
                })
                Create("UICorner", {Parent = PickerBtn, CornerRadius = UDim.new(0, 4)})
                
                -- Simple random color for demo purposes since implementing a full HSV canvas in raw Lua without assets is huge
                -- In a real scenario, this would pop up a color wheel.
                PickerBtn.MouseButton1Click:Connect(function()
                     local NewCol = Color3.fromHSV(math.random(), 1, 1)
                     PickerBtn.BackgroundColor3 = NewCol
                     pcall(Callback, NewCol)
                end)
            end

            function Group:AddKeybind(Text, Default, Callback)
                 local KeyFrame = Create("Frame", {
                    Name = "Keybind",
                    Parent = Container,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 30)
                 })
                 
                 local Label = Create("TextLabel", {
                    Parent = KeyFrame,
                    BackgroundTransparency = 1,
                    Text = Text,
                    TextColor3 = Library.Theme.TextDim,
                    Font = Library.Font,
                    TextSize = 13,
                    Size = UDim2.new(1, -80, 1, 0),
                    TextXAlignment = Enum.TextXAlignment.Left
                 })
                 
                 local BindBtn = Create("TextButton", {
                     Parent = KeyFrame,
                     BackgroundColor3 = Library.Theme.Element,
                     Size = UDim2.new(0, 80, 0, 20),
                     Position = UDim2.new(1, -80, 0, 5),
                     Text = (Default and Default.Name) or "None",
                     Font = Library.Font,
                     TextColor3 = Library.Theme.Text,
                     TextSize = 12
                 })
                 Create("UICorner", {Parent = BindBtn, CornerRadius = UDim.new(0, 4)})
                 
                 local listening = false
                 BindBtn.MouseButton1Click:Connect(function()
                    if listening then return end
                    listening = true
                    BindBtn.Text = "..."
                    
                    local con
                    con = InputService.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.Keyboard then
                            local key = input.KeyCode
                            if key == Enum.KeyCode.Unknown then return end
                            listening = false
                            BindBtn.Text = key.Name
                            pcall(Callback, key)
                            con:Disconnect()
                        end
                    end)
                 end)
            end

            return Group
        end
        
        -- Wrappers for Main Tab (CreateGroupbox already defined)
        function TabObj:AddLeftGroupbox(Name) return self:CreateGroupbox(LeftColumn, Name) end
        function TabObj:AddRightGroupbox(Name) return self:CreateGroupbox(RightColumn, Name) end

        return TabObj
    end
    
    return Window
end

return Library
